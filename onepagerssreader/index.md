---
title: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π RSS/Atom-—Ä–∏–¥–µ—Ä
---

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ -->
<div id="feedList">
  <h3>–ú–æ–∏ –ª–µ–Ω—Ç—ã</h3>
  <div>
    <input type="text" id="newFeedUrl" placeholder="URL RSS –∏–ª–∏ Atom-–ª–µ–Ω—Ç—ã" />
  </div>
  <div>
    <input type="text" id="newFeedName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ª–µ–Ω—Ç—ã" disabled />
  </div>
  <div id="status"></div>
  <div class="controls">
    <button id="addButton" disabled onclick="addFeed()">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>
    <button onclick="exportOPML()">–≠–∫—Å–ø–æ—Ä—Ç OPML</button>
    <input type="file" id="importFile" accept=".opml" style="display:none" />
    <button onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç OPML</button>

    <!-- –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <button onclick="exportQR()">–≠–∫—Å–ø–æ—Ä—Ç QR</button>
    <button onclick="openImportModal()">–ò–º–ø–æ—Ä—Ç QR/—Å—Å—ã–ª–∫–∏/—Ñ–∞–π–ª–∞</button>
  </div>

  <div id="feedsContainer"></div>
</div>

<!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–µ–Ω—Ç—ã -->
<div>
  <input type="text" id="urlInput" placeholder="–í–≤–µ–¥–∏—Ç–µ URL RSS/Atom-–ª–µ–Ω—Ç—ã" />
  <button onclick="loadCustomFeed()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏ -->
<div class="spoiler" onclick="toggleSpoiler()">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏</div>
<div id="spoilerContent" class="spoiler-content">
  <div id="proxySettings">
    <p><label><input type="checkbox" id="proxyEnabled" checked /> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏</label></p>
    <p><label>–ê–¥—Ä–µ—Å –ø—Ä–æ–∫—Å–∏:<br>
      <input type="text" id="proxyInput" value="https://cors-anywhere.herokuapp.com/" style="width:100%;" />
    </label></p>
    <p><button onclick="resetProxy()">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button><br><small>–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ cors-anywhere —Ä–∞–∑–æ–≤–æ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø: <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">corsdemo</a></small></p>
  </div>
</div>

<!-- Feed output -->
<ul id="rssFeed"></ul>

<!-- QR Export Modal -->
<div id="qrModal" class="modal">
  <div class="box">
    <div id="qr"></div>
    <div id="qrNote" style="font-size:13px"></div>
    <div style="margin-top:8px;text-align:right"><button onclick="closeQR()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    <div style="margin-top:8px;text-align:right"><button id="copyQR" onclick="copyQR()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É —Å–æ –≤—Å–µ–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</button></div>
  </div>
</div>

<!-- Import Modal (camera / file / link) -->
<div id="importModal" class="modal">
  <div class="box">
    <div style="margin-bottom:8px;font-weight:700">–ò–º–ø–æ—Ä—Ç –ø–æ–¥–ø–∏—Å–æ–∫ ‚Äî –∫–∞–º–µ—Ä–∞ / —Ñ–∞–π–ª / —Å—Å—ã–ª–∫–∞</div>

    <!-- –ö–Ω–æ–ø–∫–∏-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ -->
    <div style="display:flex;gap:6px;margin-bottom:8px;">
      <button id="tabCamera">–ö–∞–º–µ—Ä–∞</button>
      <button id="tabFile">–§–∞–π–ª (–∫–∞—Ä—Ç–∏–Ω–∫–∞)</button>
      <button id="tabLink">–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>

    <!-- –ö–∞–º–µ—Ä–∞ -->
    <div id="paneCamera" style="display:none">
      <video id="video" autoplay playsinline></video>
      <div style="margin-top:6px">–ö–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å QR-–∫–æ–¥. –ï—Å–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ ‚Äî –∏–º–ø–æ—Ä—Ç –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      <div style="margin-top:6px;text-align:right"><button onclick="stopCameraAndClose()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
    <div id="paneFile" style="display:none">
      <input type="file" id="qrImageFile" accept="image/*" />
      <div style="margin-top:8px;text-align:right"><button onclick="closeImportModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>

    <!-- –í–≤–æ–¥ —Å—Å—ã–ª–∫–∏ -->
    <div id="paneLink" style="display:none">
      <input type="text" id="importLink" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É (–∏–ª–∏ –ø–æ–ª–Ω—ã–π URL –∏–∑ QR)" style="width:100%" />
      <div style="margin-top:8px;text-align:right">
        <button onclick="processImportFromLink()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="closeImportModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π canvas –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ -->
    <canvas id="scanCanvas" style="display:none"></canvas>
  </div>
</div>

<script>
/* ====== –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (localStorage, render, validate, add, OPML import/export, load feed) ====== */

let feeds = JSON.parse(localStorage.getItem('rssFeeds') || '[]');
let currentValidUrl = null;

function saveFeeds(){ localStorage.setItem('rssFeeds', JSON.stringify(feeds)); }

function renderFeeds(){
  const container = document.getElementById('feedsContainer');
  container.innerHTML = '';
  feeds.forEach((feed,i)=>{
    const div = document.createElement('div');
    div.className = 'feed-item';
    div.innerHTML = `<span><strong>${escapeHtml(feed.name)}</strong>: ${escapeHtml(feed.url)}</span>
      <button onclick="loadFeed(${i})">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button onclick="removeFeed(${i})">–£–¥–∞–ª–∏—Ç—å</button>`;
    container.appendChild(div);
  });
}

function removeFeed(index){
  feeds.splice(index,1);
  saveFeeds(); renderFeeds();
}

function loadFeed(index){
  document.getElementById('urlInput').value = feeds[index].url;
  loadCustomFeed();
}

/* —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã */
const urlInput = document.getElementById('newFeedUrl');
const nameInput = document.getElementById('newFeedName');
const status = document.getElementById('status');
const addButton = document.getElementById('addButton');

/* —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã */
function resetState(){
  nameInput.value=''; nameInput.disabled=true; status.innerHTML=''; status.className=''; addButton.disabled=true; currentValidUrl=null;
}
function setValid(title){ nameInput.value=title; nameInput.disabled=false; status.innerHTML=`<span class="success">–õ–µ–Ω—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞: "${escapeHtml(title)}"</span>`; addButton.disabled=false; }
function setError(msg){ status.innerHTML=`<span class="error">–û—à–∏–±–∫–∞: ${escapeHtml(msg)}</span>`; addButton.disabled=true; nameInput.disabled=true; }

/* –ø—Ä–æ–≤–µ—Ä–∫–∞ URL –ª–µ–Ω—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ –ø—Ä–æ–∫—Å–∏) */
async function validateFeedUrl(url){
  status.innerHTML = '<span class="loading">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–Ω—Ç—ã...</span>';
  addButton.disabled = true;
  const useProxy = document.getElementById('proxyEnabled').checked;
  const proxy = document.getElementById('proxyInput').value.trim();
  let finalUrl = url;
  if(useProxy && proxy){
    if(proxy === 'https://allorigins.win/raw?url=') finalUrl = proxy + encodeURIComponent(url);
    else finalUrl = proxy + url;
  }
  try{
    const resp = await fetch(finalUrl);
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const xml = new DOMParser().parseFromString(text, 'text/xml');
    const parserError = xml.querySelector('parsererror');
    if(parserError) throw new Error('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π XML: –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –Ω–µ RSS/Atom');
    const isAtom = xml.querySelector('feed') !== null;
    const isRss = xml.querySelector('rss') !== null || xml.querySelector('channel') !== null;
    if(!isAtom && !isRss) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ RSS –∏–ª–∏ Atom: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL');
    let titleNode = isAtom ? xml.querySelector('feed > title') : (xml.querySelector('channel > title') || xml.querySelector('rss > channel > title'));
    const title = titleNode ? titleNode.textContent.trim() : '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    setValid(title);
    currentValidUrl = url;
  }catch(err){
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–µ–Ω—Ç—ã:', err);
    setError(err.message || err);
    currentValidUrl = null;
  }
}

/* –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∏ */
urlInput.addEventListener('blur', ()=>{ const u = urlInput.value.trim(); if(!u){ resetState(); return; } validateFeedUrl(u); });
urlInput.addEventListener('paste', ()=>{ setTimeout(()=>{ const u=urlInput.value.trim(); if(u) validateFeedUrl(u); }, 10); });

/* –¥–æ–±–∞–≤–∏—Ç—å –ª–µ–Ω—Ç—É */
function addFeed(){
  const url = currentValidUrl;
  const name = nameInput.value.trim();
  if(!url || !name) return;
  if(feeds.some(f=>f.url===url)){ setError('–≠—Ç–∞ –ª–µ–Ω—Ç–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞'); return; }
  feeds.push({ name, url });
  saveFeeds(); renderFeeds();
  urlInput.value=''; resetState();
}

/* –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –ª–µ–Ω—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
async function loadFeedContent(url){
  const feedList = document.getElementById('rssFeed');
  feedList.innerHTML = '<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
  const useProxy = document.getElementById('proxyEnabled').checked;
  const proxy = document.getElementById('proxyInput').value.trim();
  let finalUrl = url;
  if(useProxy && proxy){
    if(proxy === 'https://allorigins.win/raw?url=') finalUrl = proxy + encodeURIComponent(url);
    else finalUrl = proxy + url;
  }
  try{
    const r = await fetch(finalUrl);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const xmlText = await r.text();
    const xmlDoc = new DOMParser().parseFromString(xmlText, 'text/xml');
    if(xmlDoc.querySelector('parsererror')) throw new Error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ XML');
    const isAtom = xmlDoc.querySelector('feed') !== null;
    const isRss = xmlDoc.querySelector('rss') !== null || xmlDoc.querySelector('channel') !== null;
    let items = [], titleNode = null;
    if(isAtom){ items = xmlDoc.querySelectorAll('entry'); titleNode = xmlDoc.querySelector('feed > title'); }
    else if(isRss){ items = xmlDoc.querySelectorAll('item'); titleNode = xmlDoc.querySelector('channel > title') || xmlDoc.querySelector('rss > channel > title'); }
    else throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –æ–∂–∏–¥–∞–µ—Ç—Å—è RSS –∏–ª–∏ Atom');
    const feedTitle = titleNode ? titleNode.textContent : '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    feedList.innerHTML = `<li><strong>–õ–µ–Ω—Ç–∞: ${escapeHtml(feedTitle)}</strong></li>`;
    if(items.length === 0){ feedList.innerHTML += '<li>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</li>'; return; }
    items.forEach(item=>{
      let title = '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞', link = '#';
      if(isAtom){
        const titleEl = item.querySelector('title'); title = titleEl ? titleEl.textContent : '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞';
        const linkEl = item.querySelector('link[rel="alternate"]'); link = linkEl ? linkEl.getAttribute('href') : '#';
      } else {
        const titleEl = item.querySelector('title'); title = titleEl ? titleEl.textContent : '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞';
        const linkEl = item.querySelector('link'); link = linkEl ? linkEl.textContent : '#';
      }
      const li = document.createElement('li');
      li.innerHTML = `<a href="${escapeHtml(link)}" target="_blank">${escapeHtml(title)}</a>`;
      feedList.appendChild(li);
    });
  }catch(err){
    feedList.innerHTML = `<li class="error">–û—à–∏–±–∫–∞: ${escapeHtml(err.message || err)}</li>`;
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã:', err);
  }
}

function loadCustomFeed(){ const url = document.getElementById('urlInput').value.trim(); if(!url) return alert('–í–≤–µ–¥–∏—Ç–µ URL –ª–µ–Ω—Ç—ã'); loadFeedContent(url); }

/* OPML export/import (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏—è) */
function exportOPML(){
  const opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
<head><title>–ú–æ–∏ RSS-–ø–æ–¥–ø–∏—Å–∫–∏</title></head>
<body>
${feeds.map(f => `<outline text="${escapeXmlAttr(f.name)}" type="rss" xmlUrl="${escapeXmlAttr(f.url)}"/>`).join('\n    ')}
</body>
</opml>`;
  const blob = new Blob([opml], { type: 'text/xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'rss-feeds.opml'; a.click();
}

document.getElementById('importFile').addEventListener('change', async function(e){
  const file = e.target.files[0]; if(!file) return;
  const txt = await file.text();
  const xmlDoc = new DOMParser().parseFromString(txt, 'text/xml');
  const outlines = xmlDoc.querySelectorAll('outline[type="rss"], outline[xmlUrl]');
  if(outlines.length === 0){ alert('–í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π RSS-–ª–µ–Ω—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç OPML.'); return; }
  let imported=0, already=0, invalid=0;
  const invalidUrls=[];
  const statusEl = document.getElementById('status');
  statusEl.innerHTML = `<span class="loading">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏–º–ø–æ—Ä—Ç ${outlines.length} –ª–µ–Ω—Ç...</span>`;
  addButton.disabled = true;
  async function isValidFeed(url){
    try{
      const useProxy = document.getElementById('proxyEnabled').checked;
      const proxy = document.getElementById('proxyInput').value.trim();
      let finalUrl = url;
      if(useProxy && proxy){ if(proxy === 'https://allorigins.win/raw?url=') finalUrl = proxy + encodeURIComponent(url); else finalUrl = proxy + url; }
      const r = await fetch(finalUrl);
      if(!r.ok) return false;
      const t = await r.text(); const x = new DOMParser().parseFromString(t,'text/xml');
      if(x.querySelector('parsererror')) return false;
      const isAtom = x.querySelector('feed') !== null;
      const isRss = x.querySelector('rss') !== null || x.querySelector('channel') !== null;
      return isAtom || isRss;
    }catch(e){ return false; }
  }
  for(let i=0;i<outlines.length;i++){
    const outline = outlines[i];
    const name = outline.getAttribute('text') || outline.getAttribute('title') || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    const url = outline.getAttribute('xmlUrl') || outline.getAttribute('url') || '';
    if(!name || !url){ invalid++; invalidUrls.push(url || '(no url)'); continue; }
    if(feeds.some(f=>f.url === url)){ already++; continue; }
    const ok = await isValidFeed(url);
    if(!ok){ invalid++; invalidUrls.push(url); continue; }
    feeds.push({ name, url }); imported++;
  }
  saveFeeds(); renderFeeds();
  document.getElementById('newFeedUrl').value=''; resetState();
  let report = `‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${imported}\nüîÅ –£–∂–µ –±—ã–ª–∏: ${already}\n‚ùå –ù–µ –≤–∞–ª–∏–¥–Ω—ã: ${invalid}`;
  if(invalid>0){ report += '\n\n–°–ø–∏—Å–æ–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö URL:\n' + invalidUrls.slice(0,10).join('\n'); if(invalidUrls.length>10) report += `\n... –∏ –µ—â—ë ${invalidUrls.length-10}`; }
  alert(report);
});

/* spoiler toggle and proxy reset */
function toggleSpoiler(){ const content = document.getElementById('spoilerContent'); content.style.display = content.style.display === 'block' ? 'none' : 'block'; }
function resetProxy(){ document.getElementById('proxyInput').value = 'https://cors-anywhere.herokuapp.com/'; }

/* util escape helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=> ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])); }
function escapeXmlAttr(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
renderFeeds(); resetState();

/* ====== QR Export / Import (camera, file, link) ====== */

const MAX_FEEDS_FOR_QR = 100;           // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª-–≤—É –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è QR
const MAX_QR_PAYLOAD = 1000;           // –≥—Ä—É–±–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

function exportQR(){
  if(feeds.length === 0) return alert('–ù–µ—Ç –ª–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
  if(feeds.length > MAX_FEEDS_FOR_QR) return alert(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–µ–Ω—Ç –¥–ª—è QR (–º–∞–∫—Å–∏–º—É–º ${MAX_FEEDS_FOR_QR})`);
  // –∫–æ–¥–∏—Ä—É–µ–º –≤ base64 –±–µ–∑–æ–ø–∞—Å–Ω–æ
  const json = JSON.stringify(feeds);
  const base64 = btoa(unescape(encodeURIComponent(json)));
  if(base64.length > MAX_QR_PAYLOAD) return alert('–î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –¥–ª—è QR. –°–æ–∫—Ä–∞—Ç–∏—Ç–µ —á–∏—Å–ª–æ –ø–æ–¥–ø–∏—Å–æ–∫ –∏–ª–∏ –∏–º–µ–Ω–∞.');
  const syncUrl = location.origin + location.pathname + '?sync=' + encodeURIComponent(base64);
  const copyQRButton = document.getElementById("copyQR").setAttribute("onClick", "setClipboard('"+syncUrl+"')" );
  const box = document.getElementById('qr');
  box.innerHTML = '';
  try{
    new QRCode(box, { text: syncUrl, width: 320, height: 320 });
    document.getElementById('qrNote').textContent = '–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é.';
    document.getElementById('qrModal').style.display = 'flex';
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR: ' + (e.message || e));
  }
}
function closeQR(){ document.getElementById('qrModal').style.display = 'none'; document.getElementById('qr').innerHTML = ''; document.getElementById('qrNote').textContent=''; }

async function setClipboard(text) {
  const type = "text/plain";
  const clipboardItemData = {
    [type]: text,
  };
  const clipboardItem = new ClipboardItem(clipboardItemData);
  await navigator.clipboard.write([clipboardItem]);
}

/* –ò–º–ø–æ—Ä—Ç: UI/–ª–æ–≥–∏–∫–∞ */
const importModal = document.getElementById('importModal');
const paneCamera = document.getElementById('paneCamera');
const paneFile = document.getElementById('paneFile');
const paneLink = document.getElementById('paneLink');
const video = document.getElementById('video');
const canvas = document.getElementById('scanCanvas');
const ctx = canvas.getContext && canvas.getContext('2d');
const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
let scanAnimationId = null;
let cameraStream = null;

if (isMobile) {
document.getElementById('tabCamera').addEventListener('click', ()=>{ ('camera'); });
} else document.getElementById('tabCamera').remove();
document.getElementById('tabFile').addEventListener('click', ()=>{ showPane('file'); });
document.getElementById('tabLink').addEventListener('click', ()=>{ showPane('link'); });

function openImportModal(){
  importModal.style.display = 'flex';
  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞), –∏–Ω–∞—á–µ —Ñ–∞–π–ª
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && isMobile){
    showPane('camera');
  } else {
    showPane('file');
  }
}

function showPane(name){
  paneCamera.style.display = paneFile.style.display = paneLink.style.display = 'none';
  stopCameraLoop(); // –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω
  if(name === 'camera'){
    paneCamera.style.display = 'block';
    startCamera();
  } else if(name === 'file'){
    paneFile.style.display = 'block';
  } else {
    paneLink.style.display = 'block';
  }
}

/* camera scanning */
async function startCamera(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    return;
  }
  try{
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = cameraStream;
    video.setAttribute('playsinline', true);
    await video.play();
    // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º canvas —Ä–∞–∑–º–µ—Ä —Ä–∞–≤–Ω—ã–π –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫—É
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    scanLoop();
  }catch(err){
    console.error('camera error', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ' + (err.message || err));
    showPane('file');
  }
}

function scanLoop(){
  if(video.readyState !== video.HAVE_ENOUGH_DATA){
    scanAnimationId = requestAnimationFrame(scanLoop);
    return;
  }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  try{
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if(code && code.data){
      // –Ω–∞–π–¥–µ–Ω QR ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º
      processImportString(code.data);
      stopCameraAndClose();
      return;
    }
  }catch(e){
    // jsQR –º–æ–∂–µ—Ç –±—Ä–æ—Å–∞—Ç—å ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    console.error('jsQR err', e);
  }
  scanAnimationId = requestAnimationFrame(scanLoop);
}

function stopCameraLoop(){
  if(scanAnimationId){ cancelAnimationFrame(scanAnimationId); scanAnimationId = null; }
}

function stopCameraAndClose(){
  stopCameraLoop();
  if(cameraStream){
    cameraStream.getTracks().forEach(t=>t.stop());
    cameraStream = null;
  }
  video.pause(); video.srcObject = null;
  importModal.style.display = 'none';
}

/* –∑–∞–∫—Ä—ã—Ç—å –∏–º–ø–æ—Ä—Ç (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ) */
function closeImportModal(){
  stopCameraAndClose();
  importModal.style.display = 'none';
}

/* –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å QR ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ */
document.getElementById('qrImageFile').addEventListener('change', async function(e){
  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  img.crossOrigin = 'anonymous';

  img.onload = async () => {
    try {
      // –∏–Ω–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –∑–∞–¥–∞—ë—Ç naturalWidth —Å—Ä–∞–∑—É ‚Äî –∂–¥—ë–º decode()
      if (img.decode) { try { await img.decode(); } catch {} }

      const max = 1024;
      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;
      if(!w || !h) throw new Error('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');

      if (w > max || h > max) {
        const scale = Math.min(max / w, max / h);
        w = Math.round(w * scale);
        h = Math.round(h * scale);
      }

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);

      const imageData = ctx.getImageData(0, 0, w, h);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code && code.data) {
        processImportString(code.data);
        closeImportModal();
      } else {
        alert('QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏');
      }
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è', err);
      alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + (err.message || err));
    }
  };

  img.onerror = () => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');

  const reader = new FileReader();
  reader.onload = () => { img.src = reader.result; };
  reader.readAsDataURL(file);
});


/* –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏–∑ tabLink */
function processImportFromLink(){
  const val = document.getElementById('importLink').value.trim();
  if(!val) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º sync –∏–ª–∏ —Å—Å—ã–ª–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é QR-–¥–∞–Ω–Ω—ã–µ');
  processImportString(val);
  closeImportModal();
}

/* –æ–±—â–∏–π –ø–∞—Ä—Å–µ—Ä –≤—Ö–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:
   - –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–Ω—ã–π URL —Å param sync -> –∏–∑–≤–ª–µ–∫–∞–µ–º
   - –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ base64 -> –ø—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
   - –µ—Å–ª–∏ —ç—Ç–æ —Å—Å—ã–ª–∫–∞ –±–µ–∑ sync -> –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–∞–∫ OPML –∏–ª–∏ –æ—à–∏–±–∫—É
*/
function processImportString(input){
  try{
    let base64 = null;
    // –µ—Å–ª–∏ —ç—Ç–æ URL - –∏—â–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä sync
    try{
      const u = new URL(input);
      base64 = u.searchParams.get('sync') || null;
    }catch(e){ /* –Ω–µ URL */ }

    // –µ—Å–ª–∏ –Ω–µ URL –∏ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø—Ä—è–º–æ–π base64 (–≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω) - –ø—Ä–æ–±—É–µ–º
    if(!base64){
      // —á–∞—Å—Ç–æ QR —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä—è–º–æ URL; –µ—Å–ª–∏ input –ø–æ—Ö–æ–∂–µ –Ω–∞ base64 -> –±–µ—Ä–µ–º –µ–≥–æ
      const maybe = input.trim();
      if(/^[A-Za-z0-9\-_]+=*$/.test(maybe) && maybe.length > 10) base64 = maybe;
    }

    if(!base64){
      // –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –æ–ø—Ü–∏—è: QR —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ OPML (—Ä–µ–¥–∫–æ), –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç OPML —Ç–µ–∫—Å—Ç
      // –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ XML OPML
      if(maybeLooksLikeXML(input)){
        importOpmlText(input);
        return;
      }
      return alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä sync –∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ QR/—Å—Å—ã–ª–∫–µ');
    }

    // –¥–µ–∫–æ–¥–∏—Ä—É–µ–º base64 -> json feeds
    let json;
    try{
      json = decodeURIComponent(escape(atob(decodeURIComponent(base64))));
    }catch(e){
      // –∏–Ω–æ–≥–¥–∞ base64 –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ encodeURIComponent(base64)
      try{ json = decodeURIComponent(escape(atob(base64))); }catch(e2){ throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ'); }
    }
    const arr = JSON.parse(json);
    if(!Array.isArray(arr)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
    let added = 0;
    for(const f of arr){
      if(!f || !f.url) continue;
      if(!feeds.some(x=>x.url === f.url)) { feeds.push({ name: f.name || f.url, url: f.url }); added++; }
    }
    saveFeeds(); renderFeeds();
    alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${added} –Ω–æ–≤—ã—Ö –ª–µ–Ω—Ç`);
  }catch(err){
    console.error('import error', err);
    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + (err.message || err));
  }
}

/* helper to check XML content quickly */
function maybeLooksLikeXML(s){
  return /<\?xml|<opml|<rss|<feed/i.test(s);
}

/* OPML import if we got opml text directly */
function importOpmlText(opmlText){
  try{
    const xmlDoc = new DOMParser().parseFromString(opmlText, 'text/xml');
    const outlines = xmlDoc.querySelectorAll('outline[type="rss"], outline[xmlUrl]');
    if(outlines.length === 0){ alert('OPML –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥–ø–∏—Å–æ–∫'); return; }
    let added = 0;
    for(const o of outlines){
      const url = o.getAttribute('xmlUrl') || o.getAttribute('url');
      const name = o.getAttribute('text') || o.getAttribute('title') || url;
      if(!url) continue;
      if(!feeds.some(f=>f.url === url)){ feeds.push({ name, url }); added++; }
    }
    saveFeeds(); renderFeeds();
    alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${added} –ª–µ–Ω—Ç –∏–∑ OPML`);
  }catch(e){ alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ OPML'); }
}

/* –ü–æ–∫–∞–∑–∞—Ç—å –∏–º–ø–æ—Ä—Ç-–º–æ–¥–∞–ª –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—ã—à–µ */

/* –ê–≤—Ç–æ–∏–º–ø–æ—Ä—Ç –µ—Å–ª–∏ ?sync=... –≤ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
(function(){
  const params = new URLSearchParams(location.search);
  if(params.has('sync')){
    const raw = params.get('sync');
    if(raw){
      try{
        const dec = decodeURIComponent(raw);
        // try both variants
        let json = null;
        try{ json = decodeURIComponent(escape(atob(dec))); }catch(e){ try{ json = decodeURIComponent(escape(atob(raw))); }catch(e){} }
        if(json){
          const arr = JSON.parse(json);
          if(Array.isArray(arr)){
            let added = 0;
            for(const f of arr){
              if(!f || !f.url) continue;
              if(!feeds.some(x=>x.url === f.url)){ feeds.push({ name: f.name || f.url, url: f.url }); added++; }
            }
            saveFeeds(); renderFeeds();
            alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${added} –ª–µ–Ω—Ç –∏–∑ —Å—Å—ã–ª–∫–∏`);
          }
        }
      }catch(e){ /* ignore */ }
    }
    history.replaceState(null, '', location.pathname);
  }
})();

</script>
